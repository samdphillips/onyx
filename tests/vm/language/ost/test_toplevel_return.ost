
Object subclass: Gar [
    bar [
        | a |
        a := [ ^ 42 ] returnTo.
        ^ a + 42
    ]

    baz: trace [
        [
            trace add: 'a'.
            [
                trace add: 'b'.
                ^ nil.
                trace add: 'c'.
            ] returnTo.
            trace add: 'd'.
            [ ^ nil ] value.
            trace add: 'e'.
        ] returnTo.
        trace add: 'f'.
    ]
]

Object subclass: Bar [
    | trace |

    initialize [
        trace := OrderedCollection new.
    ]

    trace [ trace asArray ]

    run [
        | a b |
        trace add: 'a'.
        a := [ ^ trace add: 'b' ].
        b := [ a returnTo. trace add: 'c' ].
        b value.
        a value.
        trace add: 'd'
    ]
]
Tester new
    setup: [ Gar new ];

    add: 'toplevel returnTo'
    test: [:g | [ ^ 42 ] returnTo = 42 ];

    add: 'returnTo within method'
    test: [:g | g bar = 84 ];

    add: 'returnTo with multiple blocks'
    test: [:g || oc |
        oc := OrderedCollection new.
        g baz: oc.
        oc asArray
    ]
    result: #('a' 'b' 'd' 'f');

    add: 'named block'
    test: [| oc a b |
        oc := OrderedCollection new.
        a := [ ^ oc add: 'a' ].
        b := [ a returnTo. oc add: 'b' ].
        b value.
        a returnTo.
        oc add: 'c'.
        oc asArray
    ]
    result: #('a' 'b' 'a' 'c');

    add: 'named block value'
    test: [ Bar new initialize; run; trace ]
    result: #('a' 'b' 'c' 'b');

    yourself
